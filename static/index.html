<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>kraft - FFmpeg Command Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <style type="text/tailwindcss">
    @layer base {
      :root {
        --dialogue-text-color: #00FF00;
        --player-text-color: #FFFF00;
        --background-color: #1a1a1a;
        --surface-color: #2c2c2c;
        --border-color: #00FF00;
        --accent-color: #4285F4;
      }
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#019863",
            "background-dark": "#0f231c",
            "surface-dark": "var(--surface-color)",
            "dialogue-text": "var(--dialogue-text-color)",
            "player-text": "var(--player-text-color)",
            "retro-border": "var(--border-color)",
            "background-light": "#f5f8f7"
          },
          fontFamily: {
            display: "Space Grotesk",
            mono: ["Roboto Mono", "monospace"]
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          },
          boxShadow: {
            retro: "4px 4px 0px 0px var(--retro-border)"
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gradient-to-br from-background-dark via-[#05130d] to-black text-dialogue-text font-mono flex flex-col min-h-screen antialiased">

  <main class="flex-grow flex flex-col items-center justify-center px-4 py-12">
    <div class="w-full max-w-5xl flex flex-col items-center space-y-10">

      <!-- Dynamic Quote Box -->
      <div id="quoteBox" class="w-full bg-surface-dark/90 border-2 border-retro-border/80 p-6 shadow-retro transition-all duration-300 backdrop-blur-sm">
        <div class="flex items-start gap-4">
          <span class="material-icons text-retro-border text-4xl mt-1">auto_fix_high</span>
          <div>
            <p class="mb-2 text-dialogue-text leading-relaxed text-lg">Booting up digital sages...</p>
            <p class="text-dialogue-text/70 leading-relaxed italic">Summoning inspiration for your next command.</p>
          </div>
        </div>
      </div>

      <!-- Dialog Stack -->
      <div id="dialogStack" class="w-full space-y-4"></div>

      <!-- Confirmation Modal -->
  <div id="confirmOverlay" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 transition-opacity duration-150">
        <div class="bg-surface-dark/95 border-2 border-retro-border shadow-retro w-full max-w-md rounded-lg p-6 space-y-4">
          <div class="flex items-center gap-3">
            <span class="material-icons text-retro-border text-3xl" id="confirmIcon">play_circle</span>
            <div>
              <h3 id="confirmTitle" class="text-dialogue-text font-semibold text-lg">Confirm Action</h3>
              <p id="confirmHost" class="text-dialogue-text/60 text-xs uppercase tracking-widest"></p>
            </div>
          </div>
          <p id="confirmMessage" class="text-dialogue-text/80 text-sm leading-relaxed">
            Are you sure you want to continue?
          </p>
          <div class="flex justify-end gap-3">
            <button id="confirmCancel" type="button" class="px-4 py-2 border border-retro-border/50 text-dialogue-text text-sm rounded hover:bg-retro-border/10 transition">Cancel</button>
            <button id="confirmOk" type="button" class="px-4 py-2 bg-retro-border text-background-dark text-sm rounded hover:bg-retro-border/80 transition">OK</button>
          </div>
        </div>
      </div>

      <!-- Command Output Display (Hidden Initially) -->
      <div id="outputBox" class="w-full bg-surface-dark border-2 border-retro-border p-6 shadow-retro transition-all duration-300 hidden">
        <div class="mb-5">
          <p class="text-dialogue-text text-sm mb-2">Generated Command:</p>
          <div class="bg-background-dark border border-retro-border p-3 rounded">
            <code id="commandOutput" class="text-player-text text-sm break-all"></code>
          </div>
          <div class="flex flex-wrap gap-3 mt-3">
            <button id="copyBtn" type="button" class="bg-retro-border text-background-dark font-mono py-1 px-3 text-sm hover:bg-retro-border/80 transition">
              Copy Command
            </button>
            <button id="runBtn" type="button" class="bg-transparent border border-retro-border/70 text-dialogue-text py-1 px-3 text-sm hover:bg-retro-border/20 transition disabled:opacity-40 disabled:pointer-events-none">
              Execute on Server
            </button>
            <button id="refreshBtn" type="button" class="bg-transparent border border-retro-border/40 text-dialogue-text py-1 px-3 text-sm hover:bg-retro-border/20 transition">
              Refresh Output
            </button>
          </div>
          <p id="outputDestination" class="mt-3 text-dialogue-text/60 text-xs uppercase tracking-widest"></p>
        </div>
        <div id="explanationBox" class="mt-4">
          <p class="text-dialogue-text text-sm mb-2">Explanation:</p>
          <p id="explanationText" class="text-dialogue-text/80 text-sm leading-relaxed"></p>
        </div>
        <div id="reviewsBox" class="mt-4">
          <p class="text-dialogue-text text-sm mb-2">Reviews:</p>
          <div id="reviewsList" class="space-y-2"></div>
        </div>
        <div id="notesBox" class="mt-4 hidden">
          <p class="text-dialogue-text text-sm mb-2">Notes:</p>
          <ul id="notesList" class="list-disc list-inside space-y-1 text-dialogue-text/70 text-sm"></ul>
        </div>
      </div>

      <!-- Command Execution Result -->
      <div id="executionBox" class="w-full bg-surface-dark/90 border-2 border-retro-border p-6 shadow-retro transition-all duration-300 hidden">
        <div class="flex items-start gap-3 mb-4">
          <span class="material-icons text-retro-border text-3xl">play_circle</span>
          <div>
            <p id="executionStatus" class="text-dialogue-text font-semibold">Awaiting execution</p>
            <p class="text-dialogue-text/60 text-xs">Command runs on the server with outputs captured below.</p>
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <p class="text-dialogue-text/70 text-xs uppercase tracking-widest mb-2">stdout</p>
            <pre id="executionStdout" class="bg-background-dark border border-retro-border/40 rounded p-3 text-xs text-dialogue-text/80 whitespace-pre-wrap max-h-64 overflow-y-auto">(no output yet)</pre>
          </div>
          <div>
            <p class="text-dialogue-text/70 text-xs uppercase tracking-widest mb-2">stderr</p>
            <pre id="executionStderr" class="bg-background-dark border border-retro-border/40 rounded p-3 text-xs text-dialogue-text/80 whitespace-pre-wrap max-h-64 overflow-y-auto">(no output yet)</pre>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="w-full bg-surface-dark/95 border-2 border-retro-border p-5 shadow-retro transition-all duration-300 focus-within:border-[#27ff8f]">
        <form id="commandForm" enctype="multipart/form-data">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 rounded border border-retro-border/60 text-retro-border">
              <span class="material-icons">terminal</span>
            </div>
            <textarea 
              id="promptInput"
              name="prompt"
              class="flex-grow bg-transparent border border-retro-border/20 focus:border-retro-border focus:ring-0 resize-none rounded px-3 py-2 text-player-text placeholder-gray-500 text-lg transition"
              placeholder="Describe what you want to do with your media..."
              rows="3"
              required
            ></textarea>
            <div class="flex flex-col items-stretch gap-2">
              <label for="fileInput" class="flex items-center justify-center h-10 w-10 rounded border border-retro-border/40 hover:bg-retro-border/10 cursor-pointer transition">
                <span class="material-icons text-retro-border">attach_file</span>
              </label>
              <input 
                type="file" 
                id="fileInput" 
                name="files"
                multiple 
                accept="video/*,audio/*,image/*"
                class="hidden"
              />
              <button 
                type="submit"
                id="submitBtn"
                class="flex items-center justify-center h-10 w-10 rounded bg-retro-border text-background-dark hover:bg-retro-border/80 transition"
              >
                <span class="material-icons">rocket_launch</span>
              </button>
              <button
                type="button"
                id="clearBtn"
                class="flex items-center justify-center h-10 w-10 rounded border border-retro-border/40 text-retro-border hover:bg-retro-border/10 transition"
                title="Clear prompt and selections"
              >
                <span class="material-icons">backspace</span>
              </button>
            </div>
          </div>
          
          <!-- File List Display -->
          <div id="fileList" class="mt-3 space-y-1 hidden">
            <p class="text-dialogue-text text-sm">Selected Files:</p>
            <div id="fileItems" class="text-player-text text-sm"></div>
          </div>

          <!-- Advanced Controls -->
          <div class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div class="flex flex-col gap-1">
              <label for="outputPath" class="text-dialogue-text/80 text-xs uppercase tracking-widest">Output filename/path</label>
              <input
                type="text"
                id="outputPath"
                name="output_path"
                placeholder="custom-output.mp4"
                class="bg-background-dark border border-retro-border/30 focus:border-retro-border focus:ring-0 rounded px-3 py-2 text-sm text-player-text placeholder:text-dialogue-text/40"
                autocomplete="off"
              />
              <p class="text-dialogue-text/50 text-xs">Saved inside outputs/; nested folders allowed.</p>
            </div>
            <div class="flex flex-col gap-1">
              <label for="maxIters" class="text-dialogue-text/80 text-xs uppercase tracking-widest">Max iterations</label>
              <input
                type="number"
                id="maxIters"
                name="max_iters"
                min="1"
                max="6"
                value="3"
                class="bg-background-dark border border-retro-border/30 focus:border-retro-border focus:ring-0 rounded px-3 py-2 text-sm text-player-text"
              />
              <p class="text-dialogue-text/50 text-xs">Controls generator + critic refinement loops.</p>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-dialogue-text/80 text-xs uppercase tracking-widest">Options</label>
              <label class="flex items-center gap-2 text-sm text-dialogue-text/80">
                <input type="checkbox" id="enableCritic" name="enable_critic" value="true" class="accent-retro-border" checked />
                Enable critic pass
              </label>
              <label class="flex items-center gap-2 text-sm text-dialogue-text/80">
                <input type="checkbox" id="enableExplain" name="enable_explain" value="true" class="accent-retro-border" checked />
                Generate explanation
              </label>
            </div>
          </div>
        </form>
      </div>

      <!-- Loading Indicator -->
      <div id="loadingBox" class="w-full bg-surface-dark border-2 border-retro-border p-6 shadow-retro transition-all duration-300 hidden">
        <div class="flex items-center justify-center space-x-3">
          <div class="animate-pulse text-dialogue-text text-lg">Processing</div>
          <div class="flex space-x-1">
            <span class="animate-ping inline-block w-2 h-2 bg-retro-border rounded-full"></span>
            <span class="animate-ping inline-block w-2 h-2 bg-retro-border rounded-full" style="animation-delay: 0.2s"></span>
            <span class="animate-ping inline-block w-2 h-2 bg-retro-border rounded-full" style="animation-delay: 0.4s"></span>
          </div>
        </div>
      </div>

      <!-- Effect Blocks -->
      <section class="w-full">
        <div class="bg-surface-dark/90 border-2 border-retro-border p-6 shadow-retro transition-all duration-300 backdrop-blur-sm">
          <div class="flex items-center justify-between mb-5">
            <div>
              <h2 class="flex items-center gap-2 text-lg text-dialogue-text">
                <span class="material-icons text-retro-border text-3xl">tune</span>
                Effect Blocks
              </h2>
              <p class="text-sm text-dialogue-text/70">Pick a block to auto-fill a proven prompt.</p>
            </div>
          </div>
          <div id="effectsGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            <!-- Cards rendered via JS -->
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
  const API_BASE = window.location.origin;
  const quoteBox = document.getElementById('quoteBox');
  const promptInput = document.getElementById('promptInput');
  const outputPathInput = document.getElementById('outputPath');
  const maxItersInput = document.getElementById('maxIters');
  const enableCriticInput = document.getElementById('enableCritic');
  const enableExplainInput = document.getElementById('enableExplain');
  const commandOutputEl = document.getElementById('commandOutput');
  const copyBtn = document.getElementById('copyBtn');
  const runBtn = document.getElementById('runBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const dialogStack = document.getElementById('dialogStack');
  const confirmOverlay = document.getElementById('confirmOverlay');
  const confirmTitle = document.getElementById('confirmTitle');
  const confirmMessage = document.getElementById('confirmMessage');
  const confirmHost = document.getElementById('confirmHost');
  const confirmIcon = document.getElementById('confirmIcon');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmOk = document.getElementById('confirmOk');
  const outputDestination = document.getElementById('outputDestination');
  const notesBox = document.getElementById('notesBox');
  const notesList = document.getElementById('notesList');
  const executionBox = document.getElementById('executionBox');
  const executionStatus = document.getElementById('executionStatus');
  const executionStdout = document.getElementById('executionStdout');
  const executionStderr = document.getElementById('executionStderr');
  runBtn.disabled = true;

  const dialogVariants = {
    info: {
      icon: 'info',
      border: 'border-accent/60',
      bg: 'bg-accent/10',
      text: 'text-accent',
    },
    success: {
      icon: 'check_circle',
      border: 'border-[#27ff8f]/80',
      bg: 'bg-[#27ff8f]/10',
      text: 'text-[#27ff8f]',
    },
    error: {
      icon: 'error',
      border: 'border-red-500/70',
      bg: 'bg-red-500/10',
      text: 'text-red-400',
    },
    warning: {
      icon: 'warning',
      border: 'border-yellow-500/70',
      bg: 'bg-yellow-500/10',
      text: 'text-yellow-400',
    },
  };

  function showDialog(type, title, message, opts = {}) {
    const variant = dialogVariants[type] || dialogVariants.info;
    const card = document.createElement('div');
    card.className = `dialog-card relative overflow-hidden border-2 ${variant.border} ${variant.bg} rounded-lg p-4 shadow-retro/50 transition`;
    card.innerHTML = `
      <div class="flex items-start gap-3">
        <span class="material-icons ${variant.text} text-3xl">${variant.icon}</span>
        <div class="flex-1">
          <h3 class="text-dialogue-text font-semibold text-sm uppercase tracking-wide">${title}</h3>
          <p class="text-dialogue-text/80 text-sm mt-1 leading-relaxed">${message}</p>
        </div>
        <button type="button" class="text-dialogue-text/60 hover:text-dialogue-text" aria-label="Dismiss">
          <span class="material-icons text-base">close</span>
        </button>
      </div>
    `;

    const closeBtn = card.querySelector('button');
    closeBtn.addEventListener('click', () => {
      card.classList.add('opacity-0', '-translate-y-2');
      setTimeout(() => card.remove(), 180);
    });

    dialogStack.appendChild(card);

    const autoDismiss = opts.autoDismiss ?? 6000;
    if (autoDismiss) {
      setTimeout(() => {
        if (!card.isConnected) return;
        card.classList.add('opacity-0', '-translate-y-2');
        setTimeout(() => card.remove(), 180);
      }, autoDismiss);
    }
  }

  function clearDialogs() {
    dialogStack.innerHTML = '';
  }

  function resetOutputPanels() {
    commandOutputEl.textContent = '';
    document.getElementById('explanationText').textContent = '';
    document.getElementById('reviewsList').innerHTML = '';
    outputDestination.textContent = '';
    notesList.innerHTML = '';
    notesBox.classList.add('hidden');
    outputBox.classList.add('hidden');
    executionBox.classList.add('hidden');
    executionStatus.textContent = 'Awaiting execution';
    executionStdout.textContent = '(no output yet)';
    executionStderr.textContent = '(no output yet)';
    runBtn.disabled = true;
  }

  function showConfirmDialog({
    title = 'Confirm Action',
    message = 'Are you sure?',
    confirmText = 'OK',
    cancelText = 'Cancel',
    icon = 'help',
    host = '',
  } = {}) {
    return new Promise(resolve => {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      confirmHost.textContent = host;
      confirmIcon.textContent = icon;
      confirmOk.textContent = confirmText;
      confirmCancel.textContent = cancelText;

      confirmOverlay.classList.remove('hidden');
      confirmOverlay.classList.add('opacity-0');
      requestAnimationFrame(() => {
        confirmOverlay.classList.remove('opacity-0');
      });

      function cleanup(result) {
        confirmOverlay.classList.add('opacity-0');
        setTimeout(() => {
          confirmOverlay.classList.add('hidden');
          confirmOverlay.classList.remove('opacity-0');
        }, 150);
        confirmCancel.removeEventListener('click', onCancel);
        confirmOk.removeEventListener('click', onConfirm);
        confirmOverlay.removeEventListener('click', onOverlayClick);
        window.removeEventListener('keydown', onKeydown);
        resolve(result);
      }

      function onCancel() {
        cleanup(false);
      }

      function onConfirm() {
        cleanup(true);
      }

      function onOverlayClick(event) {
        if (event.target === confirmOverlay) {
          cleanup(false);
        }
      }

      function onKeydown(event) {
        if (event.key === 'Escape') {
          cleanup(false);
        }
        if (event.key === 'Enter') {
          cleanup(true);
        }
      }

      confirmCancel.addEventListener('click', onCancel);
      confirmOk.addEventListener('click', onConfirm);
      confirmOverlay.addEventListener('click', onOverlayClick);
      window.addEventListener('keydown', onKeydown);
      confirmOk.focus();
    });
  }
    
    // LLM-generated quotes about FFmpeg and media processing
    const quotes = [
      {
        text: "The terminal flickers to life, bathed in a soft green glow. A prompt appears:",
        italic: "Welcome, traveler. Your media awaits its transformation. What shall we begin with today?"
      },
      {
        text: "In the realm of digital artistry, every frame tells a story.",
        italic: "Ready your commands, for the canvas of pixels awaits your vision."
      },
      {
        text: "The ancient codec whispers secrets of compression and clarity.",
        italic: "Speak your intent, and watch as bits dance to form your creation."
      },
      {
        text: "A journey of a thousand frames begins with a single command.",
        italic: "What transformation shall we conjure from the digital ether today?"
      },
      {
        text: "In the depths of the terminal, magic and logic intertwine.",
        italic: "Your media files stand ready. Command them, and they shall obey."
      },
      {
        text: "The stream processor awakens, hungry for your instructions.",
        italic: "Feed it your vision, and marvel at what emerges from the pipeline."
      }
    ];

    let currentQuoteIndex = 0;

    function displayRandomQuote() {
      currentQuoteIndex = Math.floor(Math.random() * quotes.length);
      const quote = quotes[currentQuoteIndex];
      quoteBox.innerHTML = `
        <div class="flex items-start gap-4">
          <span class="material-icons text-retro-border text-4xl mt-1">auto_fix_high</span>
          <div>
            <p class="text-dialogue-text leading-relaxed text-lg">${quote.text}</p>
            <p class="text-dialogue-text/80 leading-relaxed text-lg italic">"${quote.italic}"</p>
          </div>
        </div>
      `;
    }

    // Display initial quote
    displayRandomQuote();

    // Rotate quotes every 15 seconds
    setInterval(displayRandomQuote, 15000);

    // File input handling
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');

    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        fileList.classList.remove('hidden');
        fileItems.innerHTML = '';
        Array.from(this.files).forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.textContent = `• ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
          fileItems.appendChild(fileItem);
        });
      } else {
        fileList.classList.add('hidden');
      }
    });

    // Effect Blocks configuration and rendering
    const effects = [
      {
        icon: 'aspect_ratio',
        title: 'Resize Visuals',
        description: 'Adjust the video to 1280x720 while keeping the original aspect ratio.',
        prompt: 'Resize the uploaded video to 1280x720 while preserving aspect ratio and padding with black bars if needed.'
      },
      {
        icon: 'opacity',
        title: 'Watermark Overlay',
        description: 'Place a watermark in the top-right corner with slight transparency.',
        prompt: 'Overlay the watermark image in the top-right corner of the video at 80% opacity.'
      },
      {
        icon: 'switch_video',
        title: 'Convert Format',
        description: 'Transcode any input to MP4 using H.264 video and AAC audio.',
        prompt: 'Convert the uploaded media to MP4 with H.264 video, AAC audio, and enable faststart for web playback.'
      },
      {
        icon: 'content_cut',
        title: 'Trim Segment',
        description: 'Extract a short clip by time range.',
        prompt: 'Trim the video from 00:00:10 to 00:00:40 while preserving audio sync.'
      },
      {
        icon: 'graphic_eq',
        title: 'Extract Audio',
        description: 'Grab the audio track and export as high-quality MP3.',
        prompt: 'Extract the audio as a 192 kbps MP3 file from the uploaded video.'
      },
      {
        icon: 'library_add',
        title: 'Merge Clips',
        description: 'Concatenate multiple videos in order.',
        prompt: 'Concatenate all provided MP4 clips together without re-encoding.'
      },
      {
        icon: 'slow_motion_video',
        title: 'Speed Ramp',
        description: 'Slow down the footage to half speed with audio pitch correction.',
        prompt: 'Slow the video to 50% speed and keep audio pitch natural.'
      },
      {
        icon: 'screen_rotation',
        title: 'Rotate & Crop',
        description: 'Rotate 90° clockwise and crop to a square.',
        prompt: 'Rotate the video 90 degrees clockwise and crop to a centered 1080x1080 square.'
      }
    ];

    const effectsGrid = document.getElementById('effectsGrid');
    let activeEffectCard = null;

    effects.forEach(effect => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'effect-card group relative bg-surface-dark/70 border border-retro-border/50 rounded-lg p-4 text-left transition hover:border-retro-border hover:shadow-retro flex flex-col gap-3';
      button.dataset.prompt = effect.prompt;
      button.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="material-icons text-retro-border text-3xl">${effect.icon}</span>
          <span class="text-xs uppercase tracking-widest text-dialogue-text/40">Prompt</span>
        </div>
        <div>
          <h3 class="text-dialogue-text font-semibold text-base">${effect.title}</h3>
          <p class="text-dialogue-text/70 text-sm leading-snug">${effect.description}</p>
        </div>
      `;

      button.addEventListener('click', () => {
        promptInput.value = effect.prompt;
        promptInput.focus();

        if (activeEffectCard) {
          activeEffectCard.classList.remove('ring-2', 'ring-retro-border', 'ring-offset-2', 'ring-offset-background-dark');
        }

        button.classList.add('ring-2', 'ring-retro-border', 'ring-offset-2', 'ring-offset-background-dark');
        activeEffectCard = button;
      });

      effectsGrid.appendChild(button);
    });

    // Form submission
  const commandForm = document.getElementById('commandForm');
  const loadingBox = document.getElementById('loadingBox');
  const outputBox = document.getElementById('outputBox');
  const submitBtn = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearBtn');

    commandForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!fileInput.files || fileInput.files.length === 0) {
        showDialog('error', 'No media input detected', 'Attach at least one media file before generating an ffmpeg command.');
        promptInput.focus();
        return;
      }

      const formData = new FormData(this);
      const iterations = Math.max(1, parseInt(maxItersInput.value || '3', 10));
      formData.set('max_iters', String(iterations));
      formData.set('enable_critic', enableCriticInput.checked ? 'true' : 'false');
      formData.set('enable_explain', enableExplainInput.checked ? 'true' : 'false');
      const outputOverride = (outputPathInput.value || '').trim();
      if (outputOverride) {
        formData.set('output_path', outputOverride);
      } else {
        formData.delete('output_path');
      }
      
      // Show loading, hide output
      loadingBox.classList.remove('hidden');
      outputBox.classList.add('hidden');
      submitBtn.disabled = true;
      runBtn.disabled = true;
      executionBox.classList.add('hidden');
      outputDestination.textContent = '';
      notesList.innerHTML = '';
      notesBox.classList.add('hidden');
      clearDialogs();
      showDialog('info', 'Processing request', 'Hang tight while Gemini drafts and validates your ffmpeg command.', { autoDismiss: 4000 });

      try {
        const response = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Display results
  commandOutputEl.textContent = data.command || '';
  document.getElementById('explanationText').textContent = data.explanation || 'No explanation provided.';
  outputDestination.textContent = data.estimated_output_path ? `Output path: ${data.estimated_output_path}` : '';
        
        // Display reviews
        const reviewsList = document.getElementById('reviewsList');
        reviewsList.innerHTML = '';
        if (data.reviews && data.reviews.length > 0) {
          data.reviews.forEach(review => {
            const reviewItem = document.createElement('div');
            reviewItem.className = 'text-sm bg-background-dark border border-retro-border/30 p-2 rounded';
            reviewItem.innerHTML = `
              <div class="text-dialogue-text/60">Iteration ${review.iteration}: ${review.ok ? '✓ OK' : '✗ Failed'}</div>
              ${review.reasons.length > 0 ? `<div class="text-dialogue-text/80 mt-1">Reasons: ${review.reasons.join(', ')}</div>` : ''}
            `;
            reviewsList.appendChild(reviewItem);
          });
        }

        if (data.notes && data.notes.length > 0) {
          notesList.innerHTML = '';
          data.notes.forEach(note => {
            const item = document.createElement('li');
            item.textContent = note;
            notesList.appendChild(item);
          });
          notesBox.classList.remove('hidden');
        }

        runBtn.disabled = !(data.command && data.command.startsWith('ffmpeg'));
        showDialog('success', 'Command ready', 'Review the generated ffmpeg command below or run it directly on the server.');

        // Show output box
  outputBox.classList.remove('hidden');
        
        // Scroll to output
        outputBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Error:', error);
        runBtn.disabled = true;
        showDialog('error', 'Generation failed', error.message || 'An unexpected error occurred while generating the command.', { autoDismiss: 8000 });
      } finally {
        loadingBox.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // Copy command button
    copyBtn.addEventListener('click', function() {
      const commandText = commandOutputEl.textContent;
      navigator.clipboard.writeText(commandText).then(() => {
        const originalText = this.textContent;
        this.textContent = '✓ Copied!';
        showDialog('success', 'Copied to clipboard', 'The ffmpeg command is ready to paste.');
        setTimeout(() => {
          this.textContent = originalText;
        }, 2000);
      }).catch(err => {
        showDialog('error', 'Copy failed', err.message || 'Unable to copy the command to your clipboard.');
      });
    });

    // Execute command button
    runBtn.addEventListener('click', async () => {
      const commandText = commandOutputEl.textContent.trim();
      if (!commandText) {
        showDialog('warning', 'No command available', 'Generate an ffmpeg command before attempting to execute it.');
        return;
      }
      const confirmed = await showConfirmDialog({
        title: 'Execute on server',
        message: 'Execute this ffmpeg command on the server now?',
        confirmText: 'Execute',
        cancelText: 'Cancel',
        icon: 'rocket_launch',
        host: window.location.origin,
      });
      if (!confirmed) {
        return;
      }

      runBtn.disabled = true;
      executionBox.classList.remove('hidden');
      executionStatus.textContent = 'Running command...';
      executionStdout.textContent = '(collecting output)';
      executionStderr.textContent = '(collecting output)';

      try {
        const execForm = new FormData();
        execForm.append('command', commandText);
        const response = await fetch(`${API_BASE}/execute`, {
          method: 'POST',
          body: execForm
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.detail || 'Execution failed');
        }

        executionStatus.textContent = data.returncode === 0
          ? 'Command completed successfully.'
          : `Command exited with code ${data.returncode}.`;
        executionStdout.textContent = data.stdout ? data.stdout.trim() : '(no stdout)';
        executionStderr.textContent = data.stderr ? data.stderr.trim() : '(no stderr)';
        const dialogType = data.returncode === 0 ? 'success' : 'warning';
        const message = data.returncode === 0 ? 'Media processing finished without errors.' : 'ffmpeg returned a non-zero status. Review stderr for additional context.';
        showDialog(dialogType, 'Execution result', message, { autoDismiss: 8000 });
      } catch (error) {
        executionStatus.textContent = `Execution failed: ${error.message}`;
        executionStdout.textContent = '(no stdout captured)';
        executionStderr.textContent = '(no stderr captured)';
        showDialog('error', 'Execution failed', error.message || 'Unable to run the command on the server.', { autoDismiss: 8000 });
      } finally {
        runBtn.disabled = false;
      }
    });

    refreshBtn.addEventListener('click', () => {
      resetOutputPanels();
      showDialog('info', 'Output cleared', 'The generated command and logs were cleared from view.');
    });

    clearBtn.addEventListener('click', () => {
      commandForm.reset();
      promptInput.value = '';
      outputPathInput.value = '';
      maxItersInput.value = '3';
      enableCriticInput.checked = true;
      enableExplainInput.checked = true;
      fileList.classList.add('hidden');
      fileItems.innerHTML = '';
      if (fileInput) {
        fileInput.value = '';
      }
      if (activeEffectCard) {
        activeEffectCard.classList.remove('ring-2', 'ring-retro-border', 'ring-offset-2', 'ring-offset-background-dark');
        activeEffectCard = null;
      }
      resetOutputPanels();
      clearDialogs();
      showDialog('info', 'Form reset', 'Prompt, files, and options have been cleared.', { autoDismiss: 3000 });
      promptInput.focus();
    });
  </script>

</body>
</html>
